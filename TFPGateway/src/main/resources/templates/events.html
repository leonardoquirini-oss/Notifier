<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TFP Gateway - Event Browser</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet">
    <style>
        .payload-cell { max-width: 350px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .msgid-cell   { max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .badge-event  { font-size: 0.8rem; }
        .table th, .table td { vertical-align: middle; }
        .json-key    { color: #881391; }
        .json-string { color: #0b7500; }
        .json-number { color: #1a01cc; }
        .json-bool   { color: #d97706; }
        .json-null   { color: #dc2626; }
        #modalPayload { background: #f8f9fa; border-radius: 4px; padding: 1rem; max-height: 60vh; overflow: auto; font-size: 0.85rem; }
    </style>
</head>
<body class="bg-light">
<div class="container-fluid py-3">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">TFP Gateway &mdash; Event Browser</h4>
        <div class="dropdown">
            <button class="btn btn-outline-secondary btn-sm" type="button"
                    data-bs-toggle="dropdown" title="Menu">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5"/>
                </svg>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="/gateway">Configurazione Gateway</a></li>
            </ul>
        </div>
    </div>

    <!-- Flash messages -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Filter bar -->
    <form th:action="@{/events}" method="get" class="card card-body mb-3">
        <div class="row g-2 align-items-end">
            <div class="col-auto">
                <label class="form-label form-label-sm mb-0">Event Type</label>
                <select name="eventType" class="form-select form-select-sm">
                    <option value="">All</option>
                    <option th:each="et : ${eventTypes}"
                            th:value="${et}" th:text="${et}"
                            th:selected="${et == selectedEventType}">
                    </option>
                </select>
            </div>
            <div class="col-auto">
                <label class="form-label form-label-sm mb-0">From</label>
                <input type="date" name="dateFrom" class="form-control form-control-sm"
                       th:value="${dateFrom}">
            </div>
            <div class="col-auto">
                <label class="form-label form-label-sm mb-0">To</label>
                <input type="date" name="dateTo" class="form-control form-control-sm"
                       th:value="${dateTo}">
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary btn-sm">Search</button>
            </div>
            <div class="col-auto ms-auto text-muted small" th:text="'Total: ' + ${totalCount} + ' events'"></div>
        </div>
    </form>

    <!-- Resend form wraps table -->
    <form id="resendForm" th:action="@{/events/resend}" method="post">

        <!-- Toolbar -->
        <div class="d-flex align-items-center gap-3 mb-2">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="selectAll" onclick="toggleAll(this)">
                <label class="form-check-label" for="selectAll">Select All</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="forceMessageId" id="forceMessageId" value="true">
                <label class="form-check-label" for="forceMessageId">
                    Force Message Id <small class="text-muted">(adds metadata: {resend:true})</small>
                </label>
            </div>
            <button type="button" class="btn btn-warning btn-sm" onclick="confirmResend()">
                Resend Selected
            </button>
            <span id="selectedCount" class="text-muted small">0 selected</span>
        </div>

        <!-- Results table -->
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead class="table-dark">
                <tr>
                    <th style="width:40px"></th>
                    <th>ID</th>
                    <th>Message ID</th>
                    <th>Event Type</th>
                    <th>Event Time</th>
                    <th>Processed At</th>
                    <th>Payload</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="evt : ${events}" style="cursor:pointer"
                    th:data-id="${evt['id_event']}"
                    th:data-msgid="${evt['message_id']}"
                    th:data-type="${evt['event_type']}"
                    th:data-event-time="${evt['event_time']}"
                    th:data-processed-at="${evt['processed_at']}"
                    th:data-payload="${evt['payload_full']}"
                    onclick="showDetail(this)">
                    <td onclick="event.stopPropagation()">
                        <input type="checkbox" class="form-check-input evt-check"
                               name="selectedIds" th:value="${evt['id_event']}"
                               onchange="updateCount()">
                    </td>
                    <td th:text="${evt['id_event']}"></td>
                    <td class="msgid-cell" th:title="${evt['message_id']}" th:text="${evt['message_id']}"></td>
                    <td>
                        <span class="badge badge-event" th:text="${evt['event_type']}"></span>
                    </td>
                    <td th:text="${evt['event_time']}"></td>
                    <td th:text="${evt['processed_at']}"></td>
                    <td class="payload-cell">
                        <code th:text="${evt['payload_preview']}"></code>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(events)}">
                    <td colspan="7" class="text-center text-muted py-4">No events found.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </form>

    <!-- Detail Modal -->
    <div class="modal fade" id="eventDetailModal" tabindex="-1" aria-labelledby="eventDetailLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventDetailLabel">Event Detail</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <dl class="row mb-3">
                        <dt class="col-sm-3">ID</dt>
                        <dd class="col-sm-9" id="modalId"></dd>
                        <dt class="col-sm-3">Message ID</dt>
                        <dd class="col-sm-9" id="modalMsgId"></dd>
                        <dt class="col-sm-3">Event Type</dt>
                        <dd class="col-sm-9" id="modalType"></dd>
                        <dt class="col-sm-3">Event Time</dt>
                        <dd class="col-sm-9" id="modalEventTime"></dd>
                        <dt class="col-sm-3">Processed At</dt>
                        <dd class="col-sm-9" id="modalProcessedAt"></dd>
                    </dl>
                    <h6>Payload</h6>
                    <pre id="modalPayload"></pre>
                </div>
                <div class="modal-footer justify-content-between">
                    <form id="modalResendForm" th:action="@{/events/resend}" method="post" class="d-flex align-items-center gap-2 mb-0">
                        <input type="hidden" name="selectedIds" id="modalSelectedId">
                        <div class="form-check mb-0">
                            <input class="form-check-input" type="checkbox" name="forceMessageId" id="modalForceMessageId" value="true">
                            <label class="form-check-label" for="modalForceMessageId">Force Message Id</label>
                        </div>
                        <button type="button" class="btn btn-warning btn-sm" onclick="confirmModalResend()">Resend Event</button>
                    </form>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <nav th:if="${totalPages > 1}">
        <ul class="pagination pagination-sm justify-content-center">
            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/events(eventType=${selectedEventType}, dateFrom=${dateFrom}, dateTo=${dateTo}, page=${currentPage - 1})}">
                    &laquo;
                </a>
            </li>
            <th:block th:each="p : ${#numbers.sequence(0, totalPages - 1)}">
                <li class="page-item" th:classappend="${p == currentPage} ? 'active'"
                    th:if="${p == 0 or p == totalPages - 1 or (p >= currentPage - 2 and p <= currentPage + 2)}">
                    <a class="page-link"
                       th:href="@{/events(eventType=${selectedEventType}, dateFrom=${dateFrom}, dateTo=${dateTo}, page=${p})}"
                       th:text="${p + 1}"></a>
                </li>
            </th:block>
            <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/events(eventType=${selectedEventType}, dateFrom=${dateFrom}, dateTo=${dateTo}, page=${currentPage + 1})}">
                    &raquo;
                </a>
            </li>
        </ul>
    </nav>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    /* --- Badge color palette --- */
    var BADGE_COLORS = [
        '#d1ecf1', // light cyan
        '#f8d7da', // light pink
        '#d4edda', // light green
        '#fff3cd', // light yellow
        '#d6d8db', // light gray
        '#cce5ff', // light blue
        '#e2d9f3', // light purple
        '#fde2c8'  // light orange
    ];

    function hashString(str) {
        var hash = 0;
        for (var i = 0; i < str.length; i++) {
            hash = ((hash << 5) - hash) + str.charCodeAt(i);
            hash |= 0;
        }
        return Math.abs(hash);
    }

    function colorBadges() {
        document.querySelectorAll('.badge-event').forEach(function(badge) {
            var text = badge.textContent.trim();
            var idx = hashString(text) % BADGE_COLORS.length;
            badge.style.backgroundColor = BADGE_COLORS[idx];
            badge.style.color = '#212529';
        });
    }

    document.addEventListener('DOMContentLoaded', colorBadges);

    /* --- Core UI --- */
    function toggleAll(source) {
        document.querySelectorAll('.evt-check').forEach(function(cb) { cb.checked = source.checked; });
        updateCount();
    }

    function updateCount() {
        var n = document.querySelectorAll('.evt-check:checked').length;
        document.getElementById('selectedCount').textContent = n + ' selected';
    }

    /* --- AJAX Resend --- */
    function showAlert(type, message) {
        // Remove any previous dynamic alerts
        document.querySelectorAll('.dynamic-alert').forEach(function(el) { el.remove(); });
        var div = document.createElement('div');
        div.className = 'alert alert-' + type + ' alert-dismissible fade show dynamic-alert';
        div.setAttribute('role', 'alert');
        div.innerHTML = '<span>' + message + '</span>' +
            '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
        var container = document.querySelector('.container-fluid');
        var header = container.querySelector('.d-flex');
        header.insertAdjacentElement('afterend', div);
    }

    function doResend(ids, forceMessageId) {
        var params = new URLSearchParams();
        ids.forEach(function(id) { params.append('selectedIds', id); });
        if (forceMessageId) params.append('forceMessageId', 'true');

        fetch(/*[[@{/events/resend}]]*/ '/events/resend', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString()
        })
        .then(function(resp) {
            if (!resp.ok && !resp.redirected) throw new Error('HTTP ' + resp.status);
            showAlert('success', ids.length + ' event(s) resent successfully.');
        })
        .catch(function(err) {
            showAlert('danger', 'Resend failed: ' + err.message);
        });
    }

    function confirmResend() {
        var checked = document.querySelectorAll('.evt-check:checked');
        if (checked.length === 0) {
            alert('Please select at least one event.');
            return;
        }
        var ids = Array.from(checked).map(function(cb) { return cb.value; });
        var force = document.getElementById('forceMessageId').checked;
        var meta = force ? '\n(metadata {resend:true} will be added)' : '';
        if (confirm('Resend ' + ids.length + ' event(s) to Valkey streams?' + meta)) {
            doResend(ids, force);
        }
    }

    function confirmModalResend() {
        var id = document.getElementById('modalSelectedId').value;
        var force = document.getElementById('modalForceMessageId').checked;
        var meta = force ? '\n(metadata {resend:true} will be added)' : '';
        if (confirm('Resend this event to Valkey streams?' + meta)) {
            doResend([id], force);
            bootstrap.Modal.getInstance(document.getElementById('eventDetailModal')).hide();
        }
    }

    /* --- Detail Modal --- */
    function showDetail(tr) {
        document.getElementById('modalId').textContent = tr.dataset.id;
        document.getElementById('modalMsgId').textContent = tr.dataset.msgid;
        document.getElementById('modalType').textContent = tr.dataset.type;
        document.getElementById('modalEventTime').textContent = formatTs(tr.dataset.eventTime);
        document.getElementById('modalProcessedAt').textContent = formatTs(tr.dataset.processedAt);

        document.getElementById('modalSelectedId').value = tr.dataset.id;

        var raw = tr.dataset.payload || '';
        try {
            var obj = JSON.parse(raw);
            var pretty = JSON.stringify(obj, null, 2);
            document.getElementById('modalPayload').innerHTML = syntaxHighlight(pretty);
        } catch (e) {
            document.getElementById('modalPayload').textContent = raw;
        }

        new bootstrap.Modal(document.getElementById('eventDetailModal')).show();
    }

    /* --- Utilities --- */
    function formatTs(raw) {
        if (!raw) return '';
        var d = new Date(raw);
        if (isNaN(d.getTime())) return raw;
        var dd = String(d.getDate()).padStart(2, '0');
        var mm = String(d.getMonth() + 1).padStart(2, '0');
        var yyyy = d.getFullYear();
        var hh = String(d.getHours()).padStart(2, '0');
        var mi = String(d.getMinutes()).padStart(2, '0');
        var ss = String(d.getSeconds()).padStart(2, '0');
        var ms = String(d.getMilliseconds()).padStart(3, '0');
        return dd + '/' + mm + '/' + yyyy + ' ' + hh + ':' + mi + ':' + ss + '.' + ms;
    }

    function syntaxHighlight(json) {
        json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return json.replace(
            /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
            function (match) {
                var cls = 'json-number';
                if (/^"/.test(match)) {
                    cls = /:$/.test(match) ? 'json-key' : 'json-string';
                } else if (/true|false/.test(match)) {
                    cls = 'json-bool';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            }
        );
    }
</script>
</body>
</html>
