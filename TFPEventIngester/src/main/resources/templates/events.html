<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TFP Event Ingester - Event Browser</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .table th, .table td { vertical-align: middle; font-size: 0.85rem; }
        .msgid-cell { max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .unit-cell  { max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    </style>
</head>
<body class="bg-light">
<div class="container-fluid py-3">

    <h4 class="mb-3">TFP Event Ingester &mdash; Event Browser</h4>

    <!-- Nav Tabs -->
    <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link" th:classappend="${activeTab == 'events'} ? ' active'" id="events-tab"
                    data-bs-toggle="tab" data-bs-target="#events-pane" type="button" role="tab">
                Unit Events
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" th:classappend="${activeTab == 'positions'} ? ' active'" id="positions-tab"
                    data-bs-toggle="tab" data-bs-target="#positions-pane" type="button" role="tab">
                Unit Positions
            </button>
        </li>
    </ul>

    <div class="tab-content">

        <!-- ==================== TAB: Unit Events ==================== -->
        <div class="tab-pane fade" th:classappend="${activeTab == 'events'} ? ' show active'" id="events-pane" role="tabpanel">

            <!-- Filter bar -->
            <form th:action="@{/events}" method="get" class="card card-body mb-3">
                <input type="hidden" name="tab" value="events">
                <!-- Preserve positions tab state -->
                <input type="hidden" name="posUnitNumber" th:value="${posUnitNumber}">
                <input type="hidden" name="posUnitTypeCode" th:value="${posUnitTypeCode}">
                <input type="hidden" name="posDateFrom" th:value="${posDateFrom}">
                <input type="hidden" name="posDateTo" th:value="${posDateTo}">
                <input type="hidden" name="posUnlinkedOnly" th:value="${posUnlinkedOnly}">
                <input type="hidden" name="posPage" th:value="${posCurrentPage}">

                <div class="row g-2 align-items-end">
                    <div class="col-auto">
                        <label class="form-label form-label-sm mb-0">Unit Number</label>
                        <input type="text" name="evtUnitNumber" class="form-control form-control-sm"
                               placeholder="Search..." th:value="${evtUnitNumber}">
                    </div>
                    <div class="col-auto">
                        <label class="form-label form-label-sm mb-0">Unit Type</label>
                        <select name="evtUnitTypeCode" class="form-select form-select-sm">
                            <option value="">All</option>
                            <option th:each="code : ${evtUnitTypeCodes}"
                                    th:value="${code}" th:text="${code}"
                                    th:selected="${code == evtUnitTypeCode}">
                            </option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <label class="form-label form-label-sm mb-0">From</label>
                        <input type="date" name="evtDateFrom" class="form-control form-control-sm"
                               th:value="${evtDateFrom}">
                    </div>
                    <div class="col-auto">
                        <label class="form-label form-label-sm mb-0">To</label>
                        <input type="date" name="evtDateTo" class="form-control form-control-sm"
                               th:value="${evtDateTo}">
                    </div>
                    <div class="col-auto">
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" name="evtUnlinkedOnly"
                                   value="true" id="evtUnlinkedOnly" th:checked="${evtUnlinkedOnly}">
                            <label class="form-check-label" for="evtUnlinkedOnly">Unlinked Only</label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary btn-sm">Search</button>
                    </div>
                    <div class="col-auto ms-auto text-muted small"
                         th:text="'Total: ' + ${evtTotalCount} + ' events'"></div>
                </div>
            </form>

            <!-- Events table -->
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Message ID</th>
                        <th>Type</th>
                        <th>Unit Number</th>
                        <th>Unit Type</th>
                        <th>Event Time</th>
                        <th>Severity</th>
                        <th>Container #</th>
                        <th>Trailer</th>
                        <th>Vehicle</th>
                        <th>Create Time</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="evt : ${unitEvents}"
                        th:classappend="${evt['container_number'] == null and evt['id_trailer'] == null and evt['id_vehicle'] == null} ? 'table-warning'">
                        <td th:text="${evt['id_unit_event']}"></td>
                        <td class="msgid-cell" th:title="${evt['message_id']}" th:text="${evt['message_id']}"></td>
                        <td th:text="${evt['type']}"></td>
                        <td class="unit-cell" th:title="${evt['unit_number']}" th:text="${evt['unit_number']}"></td>
                        <td th:text="${evt['unit_type_code']}"></td>
                        <td th:text="${evt['event_time']}"></td>
                        <td th:text="${evt['severity']}"></td>
                        <td>
                            <span th:if="${evt['container_number'] != null}" th:text="${evt['container_number']}"></span>
                            <span th:if="${evt['container_number'] == null}" class="badge bg-danger">&mdash;</span>
                        </td>
                        <td>
                            <span th:if="${evt['id_trailer'] != null}" th:text="${evt['id_trailer']}"></span>
                            <span th:if="${evt['id_trailer'] == null}" class="badge bg-danger">&mdash;</span>
                        </td>
                        <td>
                            <span th:if="${evt['id_vehicle'] != null}" th:text="${evt['id_vehicle']}"></span>
                            <span th:if="${evt['id_vehicle'] == null}" class="badge bg-danger">&mdash;</span>
                        </td>
                        <td th:text="${evt['create_time']}"></td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(unitEvents)}">
                        <td colspan="11" class="text-center text-muted py-4">No events found.</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <nav th:if="${evtTotalPages > 1}">
                <ul class="pagination pagination-sm justify-content-center">
                    <li class="page-item" th:classappend="${evtCurrentPage == 0} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/events(tab='events',
                               evtUnitNumber=${evtUnitNumber}, evtUnitTypeCode=${evtUnitTypeCode},
                               evtDateFrom=${evtDateFrom}, evtDateTo=${evtDateTo},
                               evtUnlinkedOnly=${evtUnlinkedOnly}, evtPage=${evtCurrentPage - 1},
                               posUnitNumber=${posUnitNumber}, posUnitTypeCode=${posUnitTypeCode},
                               posDateFrom=${posDateFrom}, posDateTo=${posDateTo},
                               posUnlinkedOnly=${posUnlinkedOnly}, posPage=${posCurrentPage})}">&laquo;</a>
                    </li>
                    <th:block th:each="p : ${#numbers.sequence(0, evtTotalPages - 1)}">
                        <li class="page-item" th:classappend="${p == evtCurrentPage} ? 'active'"
                            th:if="${p == 0 or p == evtTotalPages - 1 or (p >= evtCurrentPage - 2 and p <= evtCurrentPage + 2)}">
                            <a class="page-link"
                               th:href="@{/events(tab='events',
                                   evtUnitNumber=${evtUnitNumber}, evtUnitTypeCode=${evtUnitTypeCode},
                                   evtDateFrom=${evtDateFrom}, evtDateTo=${evtDateTo},
                                   evtUnlinkedOnly=${evtUnlinkedOnly}, evtPage=${p},
                                   posUnitNumber=${posUnitNumber}, posUnitTypeCode=${posUnitTypeCode},
                                   posDateFrom=${posDateFrom}, posDateTo=${posDateTo},
                                   posUnlinkedOnly=${posUnlinkedOnly}, posPage=${posCurrentPage})}"
                               th:text="${p + 1}"></a>
                        </li>
                    </th:block>
                    <li class="page-item" th:classappend="${evtCurrentPage == evtTotalPages - 1} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/events(tab='events',
                               evtUnitNumber=${evtUnitNumber}, evtUnitTypeCode=${evtUnitTypeCode},
                               evtDateFrom=${evtDateFrom}, evtDateTo=${evtDateTo},
                               evtUnlinkedOnly=${evtUnlinkedOnly}, evtPage=${evtCurrentPage + 1},
                               posUnitNumber=${posUnitNumber}, posUnitTypeCode=${posUnitTypeCode},
                               posDateFrom=${posDateFrom}, posDateTo=${posDateTo},
                               posUnlinkedOnly=${posUnlinkedOnly}, posPage=${posCurrentPage})}">&raquo;</a>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- ==================== TAB: Unit Positions ==================== -->
        <div class="tab-pane fade" th:classappend="${activeTab == 'positions'} ? ' show active'" id="positions-pane" role="tabpanel">

            <!-- Filter bar -->
            <form th:action="@{/events}" method="get" class="card card-body mb-3">
                <input type="hidden" name="tab" value="positions">
                <!-- Preserve events tab state -->
                <input type="hidden" name="evtUnitNumber" th:value="${evtUnitNumber}">
                <input type="hidden" name="evtUnitTypeCode" th:value="${evtUnitTypeCode}">
                <input type="hidden" name="evtDateFrom" th:value="${evtDateFrom}">
                <input type="hidden" name="evtDateTo" th:value="${evtDateTo}">
                <input type="hidden" name="evtUnlinkedOnly" th:value="${evtUnlinkedOnly}">
                <input type="hidden" name="evtPage" th:value="${evtCurrentPage}">

                <div class="row g-2 align-items-end">
                    <div class="col-auto">
                        <label class="form-label form-label-sm mb-0">Unit Number</label>
                        <input type="text" name="posUnitNumber" class="form-control form-control-sm"
                               placeholder="Search..." th:value="${posUnitNumber}">
                    </div>
                    <div class="col-auto">
                        <label class="form-label form-label-sm mb-0">Unit Type</label>
                        <select name="posUnitTypeCode" class="form-select form-select-sm">
                            <option value="">All</option>
                            <option th:each="code : ${posUnitTypeCodes}"
                                    th:value="${code}" th:text="${code}"
                                    th:selected="${code == posUnitTypeCode}">
                            </option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <label class="form-label form-label-sm mb-0">From</label>
                        <input type="date" name="posDateFrom" class="form-control form-control-sm"
                               th:value="${posDateFrom}">
                    </div>
                    <div class="col-auto">
                        <label class="form-label form-label-sm mb-0">To</label>
                        <input type="date" name="posDateTo" class="form-control form-control-sm"
                               th:value="${posDateTo}">
                    </div>
                    <div class="col-auto">
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" name="posUnlinkedOnly"
                                   value="true" id="posUnlinkedOnly" th:checked="${posUnlinkedOnly}">
                            <label class="form-check-label" for="posUnlinkedOnly">Unlinked Only</label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary btn-sm">Search</button>
                    </div>
                    <div class="col-auto ms-auto text-muted small"
                         th:text="'Total: ' + ${posTotalCount} + ' positions'"></div>
                </div>
            </form>

            <!-- Positions table -->
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Message ID</th>
                        <th>Unit Number</th>
                        <th>Unit Type</th>
                        <th>Lat</th>
                        <th>Lon</th>
                        <th>Position Time</th>
                        <th>Container #</th>
                        <th>Trailer</th>
                        <th>Vehicle</th>
                        <th>Create Time</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="pos : ${unitPositions}"
                        th:classappend="${pos['container_number'] == null and pos['id_trailer'] == null and pos['id_vehicle'] == null} ? 'table-warning'">
                        <td th:text="${pos['id_unit_position']}"></td>
                        <td class="msgid-cell" th:title="${pos['message_id']}" th:text="${pos['message_id']}"></td>
                        <td class="unit-cell" th:title="${pos['unit_number']}" th:text="${pos['unit_number']}"></td>
                        <td th:text="${pos['unit_type_code']}"></td>
                        <td th:text="${pos['latitude']}"></td>
                        <td th:text="${pos['longitude']}"></td>
                        <td th:text="${pos['position_time']}"></td>
                        <td>
                            <span th:if="${pos['container_number'] != null}" th:text="${pos['container_number']}"></span>
                            <span th:if="${pos['container_number'] == null}" class="badge bg-danger">&mdash;</span>
                        </td>
                        <td>
                            <span th:if="${pos['id_trailer'] != null}" th:text="${pos['id_trailer']}"></span>
                            <span th:if="${pos['id_trailer'] == null}" class="badge bg-danger">&mdash;</span>
                        </td>
                        <td>
                            <span th:if="${pos['id_vehicle'] != null}" th:text="${pos['id_vehicle']}"></span>
                            <span th:if="${pos['id_vehicle'] == null}" class="badge bg-danger">&mdash;</span>
                        </td>
                        <td th:text="${pos['create_time']}"></td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(unitPositions)}">
                        <td colspan="11" class="text-center text-muted py-4">No positions found.</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <nav th:if="${posTotalPages > 1}">
                <ul class="pagination pagination-sm justify-content-center">
                    <li class="page-item" th:classappend="${posCurrentPage == 0} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/events(tab='positions',
                               posUnitNumber=${posUnitNumber}, posUnitTypeCode=${posUnitTypeCode},
                               posDateFrom=${posDateFrom}, posDateTo=${posDateTo},
                               posUnlinkedOnly=${posUnlinkedOnly}, posPage=${posCurrentPage - 1},
                               evtUnitNumber=${evtUnitNumber}, evtUnitTypeCode=${evtUnitTypeCode},
                               evtDateFrom=${evtDateFrom}, evtDateTo=${evtDateTo},
                               evtUnlinkedOnly=${evtUnlinkedOnly}, evtPage=${evtCurrentPage})}">&laquo;</a>
                    </li>
                    <th:block th:each="p : ${#numbers.sequence(0, posTotalPages - 1)}">
                        <li class="page-item" th:classappend="${p == posCurrentPage} ? 'active'"
                            th:if="${p == 0 or p == posTotalPages - 1 or (p >= posCurrentPage - 2 and p <= posCurrentPage + 2)}">
                            <a class="page-link"
                               th:href="@{/events(tab='positions',
                                   posUnitNumber=${posUnitNumber}, posUnitTypeCode=${posUnitTypeCode},
                                   posDateFrom=${posDateFrom}, posDateTo=${posDateTo},
                                   posUnlinkedOnly=${posUnlinkedOnly}, posPage=${p},
                                   evtUnitNumber=${evtUnitNumber}, evtUnitTypeCode=${evtUnitTypeCode},
                                   evtDateFrom=${evtDateFrom}, evtDateTo=${evtDateTo},
                                   evtUnlinkedOnly=${evtUnlinkedOnly}, evtPage=${evtCurrentPage})}"
                               th:text="${p + 1}"></a>
                        </li>
                    </th:block>
                    <li class="page-item" th:classappend="${posCurrentPage == posTotalPages - 1} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/events(tab='positions',
                               posUnitNumber=${posUnitNumber}, posUnitTypeCode=${posUnitTypeCode},
                               posDateFrom=${posDateFrom}, posDateTo=${posDateTo},
                               posUnlinkedOnly=${posUnlinkedOnly}, posPage=${posCurrentPage + 1},
                               evtUnitNumber=${evtUnitNumber}, evtUnitTypeCode=${evtUnitTypeCode},
                               evtDateFrom=${evtDateFrom}, evtDateTo=${evtDateTo},
                               evtUnlinkedOnly=${evtUnlinkedOnly}, evtPage=${evtCurrentPage})}">&raquo;</a>
                    </li>
                </ul>
            </nav>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
